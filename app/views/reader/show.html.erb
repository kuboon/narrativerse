<main class="page">
  <section class="detail">
    <div class="detail-header">
      <div>
        <p class="eyebrow">Plot: <%= @plot.title %></p>
        <h1>Story</h1>
      </div>
      <div class="detail-actions">
        <% if @owns_plot %>
          <%= link_to "Add story segment", new_plot_plot_scene_link_path(@plot), class: "btn ghost" %>
        <% end %>
        <% if @fork_allowed && @focus_link %>
          <%= button_to "Fork from here", fork_plot_plot_scene_link_path(@plot, @focus_link), method: :post, class: "btn ghost" %>
        <% elsif current_user %>
          <span class="badge notice">Fork disabled for your lineage</span>
        <% end %>
      </div>
    </div>

  <% if @story_links.any? %>
    <div class="story-flow">
      <% @story_links.each do |link| %>
        <article class="panel <%= "focus" if @focus_link && link.id == @focus_link.id %>">
          <p class="meta-label">Story segment</p>
          <p><%= link.scene.text %></p>
        </article>
      <% end %>
    </div>
    <% else %>
      <div class="empty-state">
        <p>No scenes yet. Add a scene to begin the story.</p>
      </div>
    <% end %>
  </section>

  <% if @branches.any? && @focus_link %>
    <section class="grid">
      <div class="grid-header">
        <h2>Other branches from this scene</h2>
      </div>
      <div class="cards">
        <% @branches.each do |branch| %>
          <article class="card">
            <h3><%= branch.plot.title %></h3>
            <p><%= branch.plot.summary.presence || "No summary yet." %></p>
            <div class="detail-meta">
              <div>
                <span class="meta-label">Author</span>
                <span><%= branch.plot.user.name %></span>
              </div>
            </div>
            <%= link_to "Jump", reader_link_path(branch.plot, branch.id), class: "text-link" %>
          </article>
        <% end %>
      </div>
    </section>
  <% end %>

  <% if @plot_elements.any? %>
    <section class="grid">
      <div class="grid-header">
        <h2>Cast & props</h2>
      </div>
      <div class="cards">
        <% @plot_elements.each do |plot_element| %>
          <article class="card">
            <h3><%= plot_element.element.name %></h3>
            <p class="badge"><%= plot_element.element.element_type %></p>
            <p><%= plot_element.summary.presence || plot_element.element_revision&.summary.presence || "No summary yet." %></p>
            <div class="card-actions">
              <%= link_to "Open", element_path(plot_element.element), class: "text-link" %>
              <% if plot_element.element.latest_revision && plot_element.element.latest_revision.id != plot_element.element_revision_id %>
                <span class="badge notice">New revision</span>
              <% end %>
            </div>
          </article>
        <% end %>
      </div>
    </section>
  <% end %>
</main>
