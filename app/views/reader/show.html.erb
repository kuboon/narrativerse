<main class="page reader-page">
  <section class="detail">
    <div class="detail-header">
      <div>
        <h1><%= @plot.title %></h1>
      </div>
      <div class="detail-actions">
        <% if policy(@plot).manage_story? %>
          <%= link_to "ストーリー追加", new_plot_plot_scene_link_path(@plot), class: "btn ghost" %>
        <% end %>
        <% if policy(@plot).fork? && @focus_link %>
          <%= button_to "ここから分岐", fork_plot_plot_scene_link_path(@plot, @focus_link), method: :post, class: "btn ghost" %>
        <% end %>
      </div>
    </div>

  <% if @story_links.any? %>
    <div class="reader-progress" data-reader-progress>
      <span class="reader-progress-fill" data-reader-progress-fill></span>
    </div>
    <div class="story-flow" data-reader-flow data-focus-link-id="<%= @focus_link&.id %>">
      <% @story_links.each do |link| %>
          <article id="link-<%= link.id %>" data-link-id="<%= link.id %>" class="panel <%= "focus" if @focus_link && link.id == @focus_link.id %>">
            <%= link.scene.text %>
          </article>
        <% end %>
    </div>
    <% else %>
      <div class="empty-state">
        <p>まだストーリーがありません。最初の文章を追加しましょう。</p>
      </div>
    <% end %>
  </section>

  <% if @branches.any? && @focus_link %>
    <section class="grid">
      <div class="grid-header">
        <h2>この場面からの分岐</h2>
      </div>
      <div class="cards">
        <% @branches.each do |branch| %>
          <article class="card">
            <h3><%= branch.plot.title %></h3>
            <p><%= branch.plot.summary.presence || "まだ概要がありません。" %></p>
            <div class="detail-meta">
              <div>
                <span class="meta-label">作成者</span>
                <span><%= branch.plot.user.name %></span>
              </div>
            </div>
            <%= link_to "移動", reader_link_path(branch.plot, branch.id), class: "text-link" %>
          </article>
        <% end %>
      </div>
    </section>
  <% end %>

  <% if @plot_elements.any? %>
    <section class="grid">
      <div class="grid-header">
        <h2>登場要素</h2>
      </div>
      <div class="cards">
        <% @plot_elements.each do |plot_element| %>
          <article class="card">
            <h3><%= plot_element.element.name %></h3>
            <p class="badge"><%= t("elements.types.#{plot_element.element.element_type.downcase}") %></p>
            <p><%= plot_element.summary.presence || plot_element.element_revision&.summary.presence || "まだ概要がありません。" %></p>
            <div class="card-actions">
              <%= link_to "詳細", element_path(plot_element.element), class: "text-link" %>
              <% if plot_element.element.latest_revision && plot_element.element.latest_revision.id != plot_element.element_revision_id %>
                <span class="badge notice">更新あり</span>
              <% end %>
            </div>
          </article>
        <% end %>
      </div>
    </section>
  <% end %>
</main>

<script>
  (function() {
    const initReader = () => {
      const flow = document.querySelector("[data-reader-flow]");
      const progress = document.querySelector("[data-reader-progress]");
      if (!flow || !progress) return;
      if (flow.dataset.readerBound === "true") return;
      flow.dataset.readerBound = "true";

      const fill = progress.querySelector("[data-reader-progress-fill]");
      const focusId = flow.dataset.focusLinkId;

      const updateProgress = () => {
        const flowTop = flow.getBoundingClientRect().top + window.scrollY;
        const flowHeight = flow.offsetHeight;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const maxScroll = flowTop + flowHeight - viewportHeight;
        if (maxScroll <= flowTop) {
          fill.style.width = "100%";
          return;
        }
        const progressValue = (window.scrollY - flowTop) / (maxScroll - flowTop);
        const clamped = Math.max(0, Math.min(1, progressValue));
        fill.style.width = `${Math.round(clamped * 100)}%`;
      };

      updateProgress();
      window.addEventListener("scroll", updateProgress, { passive: true });
      window.addEventListener("resize", updateProgress);

      if (focusId) {
        const focusPanel = document.getElementById(`link-${focusId}`);
        if (focusPanel) {
          requestAnimationFrame(() => {
            focusPanel.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        }
      }
    };

    document.addEventListener("DOMContentLoaded", initReader);
    document.addEventListener("turbo:load", initReader);
  })();
</script>
